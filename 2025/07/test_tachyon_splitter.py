# ruff: noqa: E501
from pytest import mark

Grid = list[list[str]]


def _downward_pass(grid: Grid) -> tuple[Grid, int]:
    output = [list(line) for line in grid]
    split_count = 0

    for y, line in enumerate(output):
        if y == 0:
            continue

        for x, cell in enumerate(line):
            cell_above = output[y - 1][x]
            if cell_above == "S":
                output[y][x] = "|"
            elif cell == "^" and cell_above == "|":
                output[y][x - 1] = "|"
                output[y][x + 1] = "|"
                split_count += 1
            elif cell == "." and cell_above == "|":
                output[y][x] = "|"

    return output, split_count


def _parse_input(raw_input: str) -> list[list[str]]:
    return [list(line) for line in raw_input.splitlines()]


def tachyon_splitter(raw_input: str) -> int:
    grid = _parse_input(raw_input)
    _, split_count = _downward_pass(grid)
    return split_count


def quantum_tachyon_splitter(raw_input: str) -> int:
    grid = _parse_input(raw_input)
    marked_grid, _ = _downward_pass(grid)
    count_grid = [[0 for _ in line] for line in grid]

    count_grid[-1] = [1 if cell == "|" else 0 for cell in marked_grid[-1]]

    for y in range(len(grid) - 2, -1, -1):
        for x in range(len(count_grid[y])):
            if marked_grid[y][x] == "^":
                count_grid[y][x] = count_grid[y + 1][x - 1] + count_grid[y + 1][x + 1]
            elif marked_grid[y][x] in ("|", "S"):
                count_grid[y][x] = count_grid[y + 1][x]

    start_index = grid[0].index("S")
    return count_grid[0][start_index]


EXAMPLE_INPUT = """.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
..............."""
PUZZLE_INPUT = """......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^...^...................................................................
.............................................................................................................................................
..................................................................^.^...^.^..................................................................
.............................................................................................................................................
.................................................................^...^...^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^...^.^................................................................
.............................................................................................................................................
...............................................................^...^.^.^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^...^.^...^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^.^.^.^.^.^.............................................................
.............................................................................................................................................
............................................................^...^...........^...^............................................................
.............................................................................................................................................
...........................................................^.^...^.^.^.^.^.^...^.^...........................................................
.............................................................................................................................................
..........................................................^.^.^.^.^...^.^.^.^...^.^..........................................................
.............................................................................................................................................
.........................................................^...^...^.^.^.^.^...^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.^.^...^.^.^.......^.^...^.^........................................................
.............................................................................................................................................
.......................................................^.^.^.^.^.^.......^.^.^.......^.......................................................
.............................................................................................................................................
......................................................^.^.^.^.^.^...^.^.^.^.^...^.....^......................................................
.............................................................................................................................................
.....................................................^.....^.^.^.....^.^.^.^.^.......^.^.....................................................
.............................................................................................................................................
....................................................^.^.....^.^.^.^.^.^.^.^.....^.^...^.^....................................................
.............................................................................................................................................
...................................................^.^.....^.^.^...^...^.^.^.^.^...^.^.^.^...................................................
.............................................................................................................................................
..................................................^.^.^.....^.^...^.^.^.........^.^.^.^.^.^..................................................
.............................................................................................................................................
.................................................^...^...^.....^...^.^.^.^.^.....^.^.^.^.^.^.................................................
.............................................................................................................................................
................................................^.^.^.^.^...^.^.^.^.^.^.^.^...^.....^.^.^.^.^................................................
.............................................................................................................................................
...............................................^...^...^.^.......^...^.^.^.^.^.^.....^.^.....^...............................................
.............................................................................................................................................
..............................................^.^.....^.^.^.....^.^.^.....^.....^.^.......^.^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^...^.......^...^.^.^...^.^.......^.^.^...^.^.............................................
.............................................................................................................................................
............................................^.....^...^.^.^...^.^...^.^...^.^...^.^.^.^.^.^.^.^.^............................................
.............................................................................................................................................
...........................................^.^...^.^.^...^.^...^.^.^.^...^...^.^.^.^.^...^.^.....^...........................................
.............................................................................................................................................
..........................................^...^.^.....^.^.......^...^...^...^.......^...^.^.......^..........................................
.............................................................................................................................................
.........................................^.......^...^.^.^.....^.^.^.^...^.^...^.^...^.^.^.^.^.^...^.........................................
.............................................................................................................................................
........................................^.^.^.^...^.^.^.^.^.....^...^...^.^.....^...^.^.^.^...^.^...^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.......^.^.^...^.......^.^.^...^.^.^.^...^.^.....^.^.......................................
.............................................................................................................................................
......................................^...^.....^.^...^.........^.^.^...^.^.^.^.^...^...^.....^.^.^.^.^......................................
.............................................................................................................................................
.....................................^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^.^...^...^.^.^.....^.....................................
.............................................................................................................................................
....................................^.^.^.^.^.^.......^.^.^.^.....^.^.^.^.^.^.....^.^.....^.^.^.^...^.^.^....................................
.............................................................................................................................................
...................................^...^.^.^.^...^...^.^.........^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.....^...................................
.............................................................................................................................................
..................................^.^...^.^.^.^.^...^...^.^.^.........^.^.^.^.^.^...^.^.^.^.^.^.....^.^.^.^..................................
.............................................................................................................................................
.................................^.^.....^...^.^.^.^...^...^.^.^.^.^.^...^.^.^.^.....^.^...^.^.^...^.^.^...^.................................
.............................................................................................................................................
................................^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^...^.^...^.^...^.^.^.^...^.^.^.^.^.^...^................................
.............................................................................................................................................
...............................^...^...^...^.^.^.^.^...^.^.^...^.^...^.^.^.^.....^...^.^...^.......^.......^.^...............................
.............................................................................................................................................
..............................^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^...^.......^...^.^.^.^.^...^.......^.^.^.^.^.^..............................
.............................................................................................................................................
.............................^.^.^.....^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...^...^.^.....^...^...^.............................
.............................................................................................................................................
............................^.^...^.^.^.^.^.^.^.^...^.^...^.....^.^.^.^.^...^.^.^.^...^...^.^.^.^.^.^.^...^...^.^............................
.............................................................................................................................................
...........................^.^...^.^.....^...^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^...^.....^.^.^...^...^.^.^.^.^.^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.^...^.^.^.^...^.^.......^.^...^.^...^...^.....^.^.^...^.....^...^.^.^.^.^.^.^..........................
.............................................................................................................................................
.........................^.^.^.^.^.^.^.....^...^.^.^.^.^.^...^.^.^.^.^.^...^.........^.....^.^.^.^.^...^...^.....^.^.........................
.............................................................................................................................................
........................^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.....^.^.^.^.^.^.^.....^...^.^.^.^.^.^...^.^.^.^...^...^.^........................
.............................................................................................................................................
.......................^.^.^.^.^...^...^.^...^.^.^.^.^.^...^...^.^...^.^.^.^.........^.^.^.^.....^.^.^.^.^...^.^...^.^.......................
.............................................................................................................................................
......................^.^.^.^.^.^.^.^.....^.....^.^.^.^.^.^.^.^.^.^.....^.^.^...^...^.^.^.^.....^.^.^.....^.^.^...^.^.^......................
.............................................................................................................................................
.....................^.^...^...^.^.^.^.^.^.^...^.^...^...^.^...^.^...^.....^.^.^.....^.^.^...^.^.^.^.^.^.^.^.^...^...^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^...^.^.^...^.^.^...^...^.^.^.......^.^.^...^....................
.............................................................................................................................................
...................^...^...^.^.^.^.^...^.^.^.^.....^.^.^...^.....^.^.^.^...^.^...^.^...^...^.^.^.^...^.^.^.^.^.^.^...^.^.^...................
.............................................................................................................................................
..................^...^.^...^.^.^...^.^...^.^.^...^.^.^...........^...^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^..................
.............................................................................................................................................
.................^.^.....^.^.^...^.^...^.^.^...^...^.^...^.^.^...^.....^.^.^.^.^.^.^...^...^...^...^.^...^.^.^.^.^.^...^...^.................
.............................................................................................................................................
................^.^.^...^.^.^.^.^.^.^.^...^.^...^.^...^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.^................
.............................................................................................................................................
...............^.^.^.^.......^.^.^.^...^.^.^.^.^...^...^.......^.^.^.^.^.^.^.^.^...^.^.^.....^.^.^...^.....^.^.^...^...^.^...^...............
.............................................................................................................................................
..............^...^.^...^.^...^.^.^...^.^.^...^...^.^...^...^.........^.^.^.^.^...^...^.^...^.^...^.^.^...^...^.^.....^.^...^.^..............
.............................................................................................................................................
.............^.......^.....^...^.^.^.^.^.....^...^...^.^.^.^.^.^...^.......^.^.^.....^.^.^.^.^.^.^.^.....^.^...^...^.^.^...^.^.^.............
.............................................................................................................................................
............^.^...^...^.......^.....^...^.^.^...^.^.^.^.^.^.^.....^...^.^.....^.^.^.^.^.^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^............
.............................................................................................................................................
...........^.^...^.....^...^...^.^.^.^.^.^.^...^...^.....^.^.^.^.^...^...^.^.^.^.^...^.^.^...^.^.....^...^.......^...^...^.^...^.^...........
.............................................................................................................................................
..........^...^...^.^...^.^.^...........^...^...^.^.^.^.^.^...^.^.^...^...^.^...^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^..........
.............................................................................................................................................
.........^.^.^.....^.....^.^.^.^.^.^...^...^...^.^...^...^.^.^.^.^...^.^.^.^...^...^.^.^.^.^.^...^.....^.....^.^.^.^.^.^.^.^...^...^.........
.............................................................................................................................................
........^.^.^...^.^...^.^.^.^.^.^.^.^.^.^...^.^...^.....^.^.......^.^.......^...^...^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.^.^.^.^.^...^........
.............................................................................................................................................
.......^...^.^.^.^.^.^...^...^.^...^.....^...^...^...^.^.........^.^.^.^.^.^.^.^.^.^...^...^.^.^...^.^...^.^.^.^...^.^...^.^.^...^.^.^.......
.............................................................................................................................................
......^.^.......^.^.^...^.^.^.^...^.^.^.^.^.^...^.^.....^.^.^.......^.^.^.^.^.....^.^...^.^.^.^.^.....^.^.^.^.^.^.^.....^...^...^.^.^.^......
.............................................................................................................................................
.....^...^.^.^.....^.^...^...^.....^.^...^.^...^.^.^...^.....^.^.^...^.^.^.^.^.^...^.^.^.......^.^.....^.^.^.........^...^.^.^.^.^.^.^.^.....
.............................................................................................................................................
....^.^...^.....^.^.....^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.....^...^.^...^.^...^...^...^.^.^.^.^.^.^.^.^.^...^.^.^...^.^...^.^.^...^.^...^....
.............................................................................................................................................
...^.^.^.^.^...^...^.^.^.^.....^...^.^.^.^.....^...^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.^.^...^.^.......^.....^...^.^...
.............................................................................................................................................
..^...^.^...^.^...^.^.^.^.^...^...^.^.^.....^.^.^.^...^.^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^...^...^...^.^.......^.^.^.^.^.^.^..
.............................................................................................................................................
.^.^...^.^.....^...^.^.^.^...^.^.^...^...^.^.^.^.^.....^...^...^.^...^.^...^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.
............................................................................................................................................."""


@mark.parametrize(("raw_input", "expected_output"), [(EXAMPLE_INPUT, 21), (PUZZLE_INPUT, 1640)])
def test_tachyon_splitter(raw_input: str, expected_output: int) -> None:
    assert tachyon_splitter(raw_input) == expected_output


@mark.parametrize(("raw_input", "expected_output"), [(EXAMPLE_INPUT, 40), (PUZZLE_INPUT, 40999072541589)])
def test_quantum_tachyon_splitter(raw_input: str, expected_output: int) -> None:
    assert quantum_tachyon_splitter(raw_input) == expected_output
